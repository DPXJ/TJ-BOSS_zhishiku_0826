# 飞书API代理服务器使用说明

## 问题描述
由于浏览器的CORS（跨域资源共享）安全策略，直接从本地网页调用飞书API会被阻止。为了解决这个问题，我们提供了两种稳定方案：本地代理与线上（Vercel）无感代理。

## 解决方案
- 本地开发：运行 Node.js 代理服务器，将请求转发到飞书官方API，避免CORS。
- 线上部署：使用 Vercel Serverless 函数 `/api/feishu-proxy`，前端直接调用，无需第三方CORS服务。

## 使用步骤

### 1. 安装依赖
确保您的系统已安装Node.js，然后运行：
```bash
npm install express cors node-fetch
```

### 2. 启动本地代理服务器（开发环境）
双击运行 `start-feishu-proxy.bat` 文件，或在命令行中运行：
```bash
node feishu-proxy-server.js
```

### 3. 验证服务器状态
代理服务器启动后，访问：http://localhost:3002/health
看到 `{"status":"ok","message":"飞书代理服务器运行正常"}` 即表示成功。

### 4. 配置飞书信息
在主应用中配置您的飞书App ID、App Secret等信息。

### 5. 线上环境（Vercel）使用方式
无需任何额外配置，前端已自动将飞书API请求转发到 `/api/feishu-proxy?path=...`。

### 6. 测试同步功能
现在您可以正常使用飞书同步功能，无需打开 `cors-anywhere` 授权页面。

## 技术说明
- 本地代理监听端口：3002
- 本地代理路径：`http://localhost:3002/feishu-proxy/*`
- 线上代理路径：`/api/feishu-proxy?path=<open-apis 去掉前缀后的路径>`
- 自动转发 Authorization 等请求头与请求体到飞书官方API
- 支持所有HTTP方法（GET、POST、PATCH、PUT、DELETE）

## 常见问题

### Q: 代理服务器启动失败
A: 检查端口3002是否被占用，或安装所需的依赖包。

### Q: 同步仍然失败
A: 确保代理服务器正在运行，并检查飞书配置信息是否正确。

### Q: 端口冲突
A: 如需修改端口，请编辑 `feishu-proxy-server.js` 文件中的 `PORT` 变量，并同时修改前端脚本中本地代理地址。

## 安全说明
- 本地代理仅在本机运行，不暴露到公网
- 线上代理运行于 Vercel，无状态，转发到飞书官方服务器
- 不存储任何敏感信息

## 变更记录
- 2025-01：移除对 `cors-anywhere`/`allorigins` 的依赖，统一改为自有代理
